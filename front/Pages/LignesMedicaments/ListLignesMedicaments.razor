@page "/LignesMedicaments/ListLignesMedicaments"
@using metiers
@inject NavigationManager Navigation
@inject LigneMedicamentServices LigneMedicamentServices
@inject IJSRuntime JS

<HeaderPh />

<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5">
    <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
        <div class="bg-white dark:bg-gray-800 shadow-md sm:rounded-lg overflow-hidden">

            <!-- Header -->
            <div class="flex flex-col md:flex-row items-center justify-between p-4 bg-white gap-4">

                <!-- Search par nom -->
                <div class="w-full md:w-1/2 relative">
                    <input type="text" @bind="SearchText"
                           placeholder="Search"
                           class="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded-xl pl-11 py-2.5 shadow-sm"
                           @oninput="OnSearchChanged" />

                    <span class="absolute inset-y-0 left-3 flex items-center text-gray-500">
                        <i class="fas fa-search text-[15px]"></i>
                    </span>
                </div>             
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-4 py-3">Number</th>
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Stock</th>
                            <th class="px-4 py-3">Prescribed quantity</th>
                            <th class="px-4 py-3" colspan="2">Action</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var LigneMedicament in PagedLigneMedicaments)
                        {
                            <tr class="border-b">
                                <td class="px-4 py-3">@LigneMedicament.ligneID</td>
                                <td class="px-4 py-3">@LigneMedicament.Medicament.Nom</td>
                                <td class="px-4 py-3">@LigneMedicament.Medicament.Stock</td>
                                <td class="px-4 py-3">@LigneMedicament.qtePrescrite</td>


                                <td class="px-4 py-3 flex space-x-2">
                                    <span class="cursor-pointer px-2 py-1 rounded
            @(LigneMedicament.statut == Statut.Delivree || LigneMedicament.Medicament.Stock == 0
                                                      ? "bg-gray-200 cursor-not-allowed text-gray-400"
                                                      : "bg-[#50bfa2] hover:bg-[#95dbc8] text-white")"
                                      @onclick="@(LigneMedicament.statut == Statut.Delivree || LigneMedicament.Medicament.Stock == 0 ? null: () => Delivree(LigneMedicament.ligneID))">
                                    <i class='bx bx-cycling text-2xl'></i>
                                </span>
                            </td>


                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <Pagination TotalPages="@totalPages" CurrentPage="@currentPage" OnPageChange="LoadLigneMedicaments" />

        </div>
    </div>
</section>

@code {
    private List<LigneMedicament> LigneMedicaments = new();
    private string SearchText = "";

    private int currentPage = 1;
    private int pageSize = 5; // nombre d'éléments par page
    private int totalPages => (int)Math.Ceiling((double)FilteredLigneMedicaments.Count() / pageSize);

    private IEnumerable<LigneMedicament> FilteredLigneMedicaments =>
        string.IsNullOrWhiteSpace(SearchText)
            ? LigneMedicaments
            : LigneMedicaments.Where(p =>
                p.Medicament.Nom.Contains(SearchText, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<LigneMedicament> PagedLigneMedicaments =>
        FilteredLigneMedicaments.Skip((currentPage - 1) * pageSize).Take(pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadLigneMedicaments(currentPage);
    }

    private async Task LoadLigneMedicaments(int page)
    {
        currentPage = page;

        // Récupérer l'ID depuis le localStorage
        string medecinIdString = await JS.InvokeAsync<string>("localStorage.getItem", "userId");
        medecinIdString = medecinIdString?.Trim('"');

        // Convertir en Guid
        if (!Guid.TryParse(medecinIdString, out Guid medecinId))
        {
            // Gestion d'erreur si le guid n'est pas valide
            await JS.InvokeVoidAsync("showNotification", "ID médecin invalide !", "error");
            return;
        }

        // Passer le Guid au service
        LigneMedicaments = await LigneMedicamentServices.GetLigneMedicaments(medecinId);

        StateHasChanged();
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        currentPage = 1; // reset page à 1 après modification du filtre
    }

    private void Delivree(int id) => Navigation.NavigateTo($"/LigneMedicaments/Delivree/{id}");
}

