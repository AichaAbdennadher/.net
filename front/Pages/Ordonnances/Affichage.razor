@page "/Ordonnances/Affichage/{id:int}"
@using metiers
@inject UserServices UserServices
@inject OrdonnanceServices OrdonnanceServices
@inject LigneMedicamentServices LigneMedicamentServices
@inject NavigationManager Navigation

<link rel="stylesheet" href="css/facture-ordonnance.css">

<div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl overflow-y-auto">

        <div class="flex items-center justify-between border-b p-4">
            <h4 class="text-lg font-semibold text-[#50bfa2]"></h4>
            @* Prescription Details *@
            <button @onclick="Cancel" class="text-gray-400 hover:text-[#50bfa2]">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M1 1l6 6m0 0l6 6M7 7l6-6M7 7l-6 6" />
                </svg>
            </button>
        </div>

        @if (IsLoading)
        {
            <div class="p-6 text-center text-gray-500">Loading...</div>
        }
        else if (Ordonnance == null)
        {
            <div class="p-6 text-center text-red-500">Prescription introuvable</div>
        }
        else
        {
            <main class="cart-container">

                <!-- TITRE -->
                <h1>MEDICAL PRESCRIPTION</h1>

                <p class="ord-number">N° Prescription : <strong>@NumeroOrdonnance</strong></p>

                <!-- INFOS -->
                <div class="header">
                    <div class="company-info">
                        <h3>Doctor</h3>
                        <p>@Doctor?.Prenom @Doctor?.Nom</p>
                        <p>
                            <span class="font-medium">Specialty:</span>
                            @Doctor?.Specialite
                        </p>
                        <p>
                            <span class="font-medium">Adress:</span> @Doctor?.Adresse
                        </p>
                        <p>
                            <span class="font-medium">Email:</span> @Doctor?.Email
                        </p>
                        <p>
                            <span class="font-medium">Phone:</span> @Doctor?.Tel
                        </p>
                    </div>

                    <div class="client-info">
                        <h3>Patient</h3>
                        <p>@Ordonnance.Patient?.Nom @Ordonnance.Patient?.Prenom</p>
                        <p> <span class="font-medium">Birth date:</span> @Ordonnance.Patient?.DateNaissance.ToString("dd/MM/yyyy")</p>
                        <p><span class="font-medium">Adress:</span> @Ordonnance.Patient?.Adresse</p>
                        <p><span class="font-medium">Phone:</span> @Ordonnance.Patient?.Tel</p>
                    </div>
                </div>

                <!-- TABLE -->
                <table class="facture-table">
                    <thead>
                        <tr>
                            <th>Médicament</th>
                            <th>Dose</th>
                            <th>Quantité</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var l in Lignes)
                        {
                            <tr>
                                <td>@l.Medicament?.Nom</td>
                                <td>@l.dose</td>
                                <td>@l.qtePrescrite</td>
                            </tr>
                        }
                    </tbody>
                </table>

                <!-- SIGNATURE -->
                <div class="signature w-full flex justify-end mt-6">
                    <div class="text-right">
                        <p>Fait à Sfax, le @Ordonnance.DateCreation.ToString("dd/MM/yyyy")</p>
                        <p>Signature & Cachet</p>
                    </div>
                </div>
            </main>

            <!-- BOUTONS -->
            <div class="flex justify-end gap-2 p-4 border-t no-print">

                <button class="bg-gray-300 px-4 py-2 rounded" @onclick="Cancel">Close </button>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public int id { get; set; }

    private Ordonnance Ordonnance;
    private UserDTO Doctor;
    private List<LigneMedicament> Lignes = new();
    private bool IsLoading = true;

    string NumeroOrdonnance;
    DateTime DateValidite => DateTime.Now.AddDays(30);

    protected override async Task OnInitializedAsync()
    {
        Ordonnance = await OrdonnanceServices.GetOrdonnance(id);

        if (Ordonnance != null)
        {
            Doctor = await UserServices.GetDoctor(Ordonnance.MedecinID);
            Lignes = await LigneMedicamentServices.GetLigneMedicamentsByOrd(id);
            NumeroOrdonnance = $"ORD-{Ordonnance.DateCreation:yyyyMMdd}-{id}";
        }

        IsLoading = false;
    }

    void Cancel() => Navigation.NavigateTo("/Ordonnances/ListOrdonnancesRecus");
}
