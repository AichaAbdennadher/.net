@page "/Ordonnances/ListOrdonnancesRecus"
@using metiers
@inject NavigationManager Navigation
@inject OrdonnanceServices OrdonnanceServices
@inject IJSRuntime JS

<HeaderPh />

<section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5">
    <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
        <div class="bg-white dark:bg-gray-800 shadow-md sm:rounded-lg overflow-hidden">

            <!-- Header -->
            <div class="flex flex-col md:flex-row items-center justify-between p-4 bg-white gap-4">

                <!-- Search par patient -->
                <div class="w-full md:w-1/2 relative">
                    <input type="text"
                           @bind="SearchText"
                           placeholder="Search"
                           class="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded-xl pl-11 py-2.5 shadow-sm"
                           @oninput="OnSearchChanged" />

                    <span class="absolute inset-y-0 left-3 flex items-center text-gray-500">
                        <i class="fas fa-search text-[15px]"></i>
                    </span>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-4 py-3">Number</th>
                            <th class="px-4 py-3">Patient</th>
                            <th class="px-4 py-3">Creation date</th>
                            <th class="px-4 py-3">Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        @foreach (var ord in PagedOrdonnances)
                        {
                            <tr class="border-b">
                                <td class="px-4 py-3">@ord.OrdID</td>
                                <td class="px-4 py-3">@($"{ord.Patient.Nom} {ord.Patient.Prenom}")</td>
                                <td class="px-4 py-3">@ord.DateCreation.ToString("dd/MM/yyyy")</td>

                                <td class="px-4 py-3 flex items-center space-x-3">

                                    <!-- Voir ordonnance -->
                                    <span class="cursor-pointer p-2 rounded hover:bg-gray-100"
                                          title="Voir l’ordonnance"
                                          @onclick="() => Voir(ord.OrdID)">
                                        <i class="fa-regular fa-eye text-gray-500 text-xl"></i>
                                    </span>

                                    <!-- Délivrer ordonnance -->
                                    <span class="p-2 rounded flex items-center justify-center
                                              @(ord.Statut == Statut.Delivree
                                                                                      ? "bg-gray-200 cursor-not-allowed text-gray-400"
                                                                                      : "bg-[#50bfa2] hover:bg-[#95dbc8] text-white")"
                                          title="@(ord.Statut == Statut.Delivree
                                                                                      ? "Ordonnance déjà délivrée"
                                                                                      : "Délivrer l’ordonnance")"
                                      @onclick="@(ord.Statut == Statut.Delivree
                                                                                  ? null
                                                                                  : () => Delivrer(ord.OrdID))">
                                    <i class="bx bx-cycling text-2xl"></i>
                                </span>

                            </td>
                        </tr>
                                                }
                    </tbody>
                </table>
            </div>

            <Pagination TotalPages="@totalPages"
                        CurrentPage="@currentPage"
                        OnPageChange="LoadOrdonnances" />
        </div>
    </div>
</section>

@code {

    private List<Ordonnance> Ordonnances = new();
    private string SearchText = "";

    private int currentPage = 1;
    private int pageSize = 5;

    private int totalPages =>
        (int)Math.Ceiling((double)FilteredOrdonnances.Count() / pageSize);

    private IEnumerable<Ordonnance> FilteredOrdonnances =>
        string.IsNullOrWhiteSpace(SearchText)
            ? Ordonnances
            : Ordonnances.Where(o =>
                o.Patient.Nom.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                o.Patient.Prenom.Contains(SearchText, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<Ordonnance> PagedOrdonnances =>
        FilteredOrdonnances
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadOrdonnances(currentPage);
    }

    private async Task LoadOrdonnances(int page)
    {
        currentPage = page;

        string pharmacienId = await JS.InvokeAsync<string>("localStorage.getItem", "userId");
        pharmacienId = pharmacienId?.Trim('"');

        Ordonnances = await OrdonnanceServices.GetOrdonnancesEnvoyes(pharmacienId);
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        currentPage = 1;
    }

    private async Task Delivrer(int ordId)
    {
        var lignesNonDelivrees = await OrdonnanceServices.DelivrerOrdonnance(ordId);

        if (lignesNonDelivrees.Count == 0)
        {
            await JS.InvokeVoidAsync("showToastr", "success", "Ordonnance totalement délivrée");
        }
        else
        {
            await JS.InvokeVoidAsync("showToastr", "warning", "Certaines lignes ne sont pas délivrées");
            Navigation.NavigateTo($"/Ordonnances/OrdonnanceDelivree/{ordId}");
        }
    }

    private void Voir(int id)
        => Navigation.NavigateTo($"/Ordonnance/AffichageOrdonnance/{id}");
}
