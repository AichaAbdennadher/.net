@using metiers
@inject MedicamentServices MedicamentServices
@inject IJSRuntime JS
@inject TempOrdonnanceService TempOrdonnanceService

<div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
    <div class="flex items-center justify-between border-b pb-2 mb-4">
        <h3 class="text-lg font-semibold text-[#50bfa2]">
            @((IsEdit ? "Update" : "Add") + " medicine")
        </h3>
        <button type="button" @onclick="CloseModal" class="text-gray-400 hover:text-[#50bfa2]">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1l6 6m0 0l6 6M7 7l6-6M7 7l-6 6" />
            </svg>
        </button>
    </div>

    <EditForm Model="medicamentModel" OnValidSubmit="HandleLigneSubmit" class="space-y-3">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="relative mb-3">
            <label class="block mb-1 text-sm font-normal text-gray-500">Medicine name</label>
            <InputText @bind-Value="searchMedicament" @oninput="FilterMedicaments" placeholder="Search a medicine"
                       class="w-full p-2 border rounded focus:outline-none focus:ring-1 focus:ring-[#50bfa2] focus:border-[#50bfa2]" />
            @if (filteredMedicaments.Any() && !string.IsNullOrWhiteSpace(searchMedicament))
            {
                <ul class="absolute z-10 bg-white border rounded w-full max-h-40 overflow-y-auto">
                    @foreach (var m in filteredMedicaments)
                    {
                        <li class="p-2 hover:bg-[#50bfa2] hover:text-white cursor-pointer"
                            @onclick="() => SelectMedicament(m)">
                            @m.Nom
                        </li>
                    }
                </ul>
            }
        </div>

        <div class="mb-3">
            <label class="block mb-1 text-sm font-normal text-gray-500">Dosage</label>
            <InputText @bind-Value="medicamentModel.Dosage"
                       class="w-full border rounded p-2 focus:outline-none focus:ring-1 focus:ring-[#50bfa2] focus:border-[#50bfa2]" />
        </div>

        <div class="mb-3">
            <label class="block mb-1 text-sm font-normal text-gray-500">Quantity</label>
            <InputNumber @bind-Value="medicamentModel.Quantite"
                         class="w-full border rounded p-2 focus:outline-none focus:ring-1 focus:ring-[#50bfa2] focus:border-[#50bfa2]" min="0" />
        </div>

        <div class="flex justify-end space-x-2">
            <button type="button" class="bg-gray-300 hover:bg-gray-200 font-normal text-[#6f7885] px-4 py-2 border rounded text-sm" @onclick="CloseModal">
                Cancel
            </button>
            <button type="submit" class="bg-[#50bfa2] hover:bg-[#95dbc8] text-white px-4 py-2 border rounded text-sm font-medium">
                Save
            </button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public EventCallback<LigneMedicament> OnLigneSaved { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public Ordonnance ParentOrdonnance { get; set; }
    [Parameter] public LigneMedicament Ligne { get; set; }

    private MedicamentModel medicamentModel = new();
    private List<Medicament> allMedicaments = new();
    private List<Medicament> filteredMedicaments = new();
    private string searchMedicament = "";
    private bool IsEdit => Ligne != null;

    public class MedicamentModel
    {
        public int? Id { get; set; }
        public string Dosage { get; set; } = "";
        public int Quantite { get; set; } = 0;
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadMedicamentsByPharmacie();

        if (IsEdit)
        {
            medicamentModel.Id = Ligne.MedicamentID;
            medicamentModel.Dosage = Ligne.dose;
            medicamentModel.Quantite = Ligne.qtePrescrite;
            searchMedicament = Ligne.Medicament?.Nom ?? "";
        }
        else
        {
            medicamentModel = new MedicamentModel();
            searchMedicament = "";
        }

        filteredMedicaments = new List<Medicament>();
    }

    private async Task LoadMedicamentsByPharmacie()
    {
        var pharmaID = ParentOrdonnance?.PharmacienID ?? TempOrdonnanceService.TempPharmacieID ?? Guid.Empty;
        if (pharmaID != Guid.Empty)
        {
            allMedicaments = await MedicamentServices.GetMedicaments(pharmaID);
        }
    }

    private void SelectMedicament(Medicament med)
    {
        medicamentModel.Id = med.MedicamentID;
        searchMedicament = med.Nom;
        filteredMedicaments.Clear();
    }

    private void FilterMedicaments(ChangeEventArgs e)
    {
        searchMedicament = e.Value?.ToString() ?? "";
        filteredMedicaments = string.IsNullOrWhiteSpace(searchMedicament)
            ? new List<Medicament>()
            : allMedicaments.FindAll(m => m.Nom.Contains(searchMedicament, StringComparison.OrdinalIgnoreCase));
    }

    private async Task HandleLigneSubmit()
    {
        if (medicamentModel.Id == null || medicamentModel.Quantite <= 0)
        {
            await JS.InvokeVoidAsync("showToastr", "error", "Sélectionnez un médicament et entrez une quantité valide");
            return;
        }

        var medicament = allMedicaments.FirstOrDefault(m => m.MedicamentID == medicamentModel.Id.Value);
        if (medicament == null)
        {
            await JS.InvokeVoidAsync("showToastr", "error", "Médicament non trouvé");
            return;
        }

        // if (medicament.Stock < medicamentModel.Quantite)
        // {
        //     await JS.InvokeVoidAsync("showToastr", "error", $"Stock insuffisant! Disponible : {medicament.Stock}");
        //     return;
        // }

        if (IsEdit)
        {
            Ligne.MedicamentID = medicament.MedicamentID;
            Ligne.dose = medicamentModel.Dosage;
            Ligne.qtePrescrite = medicamentModel.Quantite;
            Ligne.Medicament = new Medicament { MedicamentID = medicament.MedicamentID, Nom = medicament.Nom };
            TempOrdonnanceService.UpdateLigne(Ligne);
        }
        else
        {
            var ligne = new LigneMedicament
            {
                MedicamentID = medicament.MedicamentID,
                dose = medicamentModel.Dosage,
                qtePrescrite = medicamentModel.Quantite,
                Medicament = new Medicament { MedicamentID = medicament.MedicamentID, Nom = medicament.Nom }
            };
            TempOrdonnanceService.AddLigne(ligne);
            Ligne = ligne;
        }

        await OnLigneSaved.InvokeAsync(Ligne);
        await OnClose.InvokeAsync();
    }

    private async Task CloseModal() => await OnClose.InvokeAsync();
}
